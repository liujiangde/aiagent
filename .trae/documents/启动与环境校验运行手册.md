# 启动与环境校验运行手册

## 概览
- 工作区：`pnpm` + Turborepo。Web 已可在本地启动：`http://localhost:3000/`。
- 开发脚本：根 `package.json` 的 `dev` 为 `turbo run dev --filter=web --include-dependencies`。
- 环境校验：Web 提供 `/api/env-check`，并在 Header 显示缺失的关键变量。

## 前置条件
- Node 版本：`>= 20`（`package.json:5-7`）。
- 启用 `pnpm`：
  - `corepack enable && corepack prepare pnpm@9.0.0 --activate`
- 安装依赖：
  - `pnpm install`

## 常见安装/启动问题与修复
- 使用 `npm ci` 报错缺少锁文件
  - 解决：改用 `pnpm install`。
- 无法解析内部共享配置包（`@aiagent/tsconfig`）为注册表包
  - 原因：工作区包不应从注册表拉取。
  - 修复：将应用/包内对 `@aiagent/*` 的依赖改为 `workspace:*`：
    - `apps/bff/package.json:22-24`
    - `apps/web/package.json:21-28`
    - `packages/retrieval/package.json:7-14`
    - `packages/tools/package.json:11-17`
    - `packages/ui/package.json:12-21`
- TypeScript Node 类型缺失（如 `node:fs`、`__dirname`、`Map/Set` 等）
  - 修复：包 TS 配置增加 `types/lib`：
    - `packages/retrieval/tsconfig.json:2-14`
    - `packages/tools/tsconfig.json:3-10`
  - UI 包增加 React 类型：
    - `packages/ui/package.json:12-21`
- Next.js 提示找不到 `@aiagent/tsconfig/tsconfig.json`
  - 修复：在 `apps/web/package.json` 里添加 `@aiagent/tsconfig: workspace:*`（`apps/web/package.json:21-28`）。
- Turbo 脚本参数错误
  - 修复：改为 `turbo run dev --filter=web --include-dependencies`（`package.json:13`）。

## 包构建与依赖
- 共享包需产出到 `dist`，并在应用侧以构建产物作为入口：
  - `packages/ui/package.json:5-7`
  - `packages/tools/package.json:5-7`
- 构建包：
  - `pnpm --filter @aiagent/retrieval build`
  - `pnpm --filter @aiagent/tools build`
  - `pnpm --filter @aiagent/ui build`

## 启动 Web
- 根目录运行：
  - `pnpm --filter web dev`
  - 或 `pnpm run dev`（调用 Turbo 执行 Web 及其依赖）
- 访问：`http://localhost:3000/`
- 环境提示：`apps/web/components/AppLayout.tsx:19-33, 44-51` 从 `/api/env-check` 拉取校验结果并在 Header 显示缺失键。

## 环境校验
- 模块：`apps/web/app/lib/env.ts:1-20`
  - `getEnv(key)`：读取并修剪
  - `getDeepseekKey()`：统一读取密钥
  - `validateRequired(keys)`：返回 `{ ok, missing }`
  - `requireDeepseekKey()`：缺失时抛错
- 路由接入：
  - `apps/web/app/api/deepseek/route.ts:38-49`
  - `apps/web/app/api/rag/answer/route.ts:44-46`
  - `apps/web/app/api/rag/kb_answer/route.ts:11-14`
  - `apps/web/app/api/rag/stream/route.ts:65-71, 121-133`
  - `apps/web/app/api/env-check/route.ts:3-12` 返回 `{ ok, missing, keys }`
- 测试：
  - `apps/web/__tests__/env.test.ts:1-17`
  - `apps/web/__tests__/env-validate.test.ts:1-21`
- 示例环境文件：
  - `apps/web/.env.example:1-2` 使用占位空值；真实密钥不应进入仓库。

## BFF 服务
- 开发启动：`pnpm --filter bff-service dev`，默认端口 `4000`（`apps/bff/src/env.ts:1-6`）。
- 入口：`apps/bff/src/index.ts:23-34` 使用 `getPort()`，并启用 CORS、dotenv。

## Docker 开发
- `Dockerfile.dev`（使用 `pnpm`）：
  - 构建：`docker build -f Dockerfile.dev -t aiagent-web-dev .`
  - 运行：`docker run -p 3000:3000 --env-file apps/web/.env.local aiagent-web-dev`
- `docker-compose.dev.yml`：
  - 启动：`docker compose -f docker-compose.dev.yml up --build`
  - 环境变量通过宿主传入：`DEEPSEEK_API_KEY`、`OPENAI_API_KEY`

## 验证
- 启动后访问 `http://localhost:3000/`。
- 如环境未配置，Header 会显示缺失键；也可直接请求 `/api/env-check` 查看详情。

## 参考与索引
- 根脚本：`package.json:12-19`
- CI 与格式化：`.github/workflows/ci.yml:13-20`、`.prettierrc`、`turbo.json:3-14`
- 包入口与构建：`packages/ui/package.json:5-7`、`packages/tools/package.json:5-7`
- 环境校验模块与路由：`apps/web/app/lib/env.ts:1-20`、`apps/web/app/api/env-check/route.ts:3-12`
