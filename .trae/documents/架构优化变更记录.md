# 架构优化变更记录

## 概述
- Monorepo 工具与质量门槛统一，环境变量治理、安全与日志路径稳定，包入口从源码改为构建产物 `dist`，并补充基础测试与格式化规范。
- 生效范围：`apps/*`、`packages/*`、CI 工作流与根脚本。

## CI 与脚本
- 更新 CI 使用 `pnpm + turbo`，执行 `lint/build/test`：`.github/workflows/ci.yml:13-20`
- 根脚本新增测试与格式化：
  - `package.json:12-24` 增加 `test`、`format`、`format:check`
  - `turbo.json:3-14` 增加 `pipeline.test`
- 新增 Prettier 配置：`.prettierrc`

## 前端（apps/web）
- 移除构建期间错误忽略：`apps/web/next.config.js:4-8`
- 统一 Lint 配置（删除旧 `.eslintrc`）：`apps/web/eslint.config.js`（保留）、移除 `apps/web/.eslintrc.json`
- 环境变量集中管理：
  - 新增模块：`apps/web/app/lib/env.ts:1-8`
  - 路由接入：
    - `apps/web/app/api/deepseek/route.ts:38-49` 使用 `getDeepseekKey`
    - `apps/web/app/api/rag/answer/route.ts:44-46` 使用 `getDeepseekKey`
    - `apps/web/app/api/rag/kb_answer/route.ts:11-14` 使用 `getDeepseekKey`
    - `apps/web/app/api/env-check/route.ts:4-8` 动态导入使用 `getDeepseekKey`
    - `apps/web/app/api/rag/stream/route.ts:65-71, 121-133` 使用 `getDeepseekKey`
- 日志路径稳定：
  - 支持 `LOG_ROOT` 控制日志根：`apps/web/app/lib/logger.ts:10-13`
- 测试用例新增：
  - 文件日志持久化：`apps/web/__tests__/logger.test.ts:1-29`
  - 环境读取与修剪：`apps/web/__tests__/env.test.ts:1-17`
- 环境示例文件安全化：
  - 清空示例密钥为占位：`apps/web/.env.example:1-2`
  - `.gitignore` 忽略真实 `.env*` 与本地 `.data`：`.gitignore:8-13, 41-44`

## 后端（apps/bff）
- 端口解析与校验模块：
  - 新增：`apps/bff/src/env.ts:1-6`
  - 使用：`apps/bff/src/index.ts:25-27`
- 路由类型标注（避免隐式 any）：`apps/bff/src/index.ts:15-21`
- 环境示例文件：`apps/bff/.env.example:1`

## 共享包（packages/*）
- 包入口改为构建产物 `dist`（降低应用对源码耦合）：
  - `packages/ui/package.json:5-7` 指向 `dist`
  - `packages/tools/package.json:5-7` 指向 `dist`
  - 声明文件输出：`packages/tools/tsconfig.json:3-8` 增加 `declaration: true`
- 应用侧移除 `paths` 对包源码映射：
  - `apps/web/tsconfig.json:3-20`
  - `apps/cli/tsconfig.json:3-16`

## 风险与注意
- CI 现使用 `pnpm`：请在本地安装 `pnpm` 或使用 CI 环境验证。
- Web 路由将在缺失密钥时返回 400；请在部署环境正确配置 `DEEPSEEK_API_KEY`。
- 包入口变更为 `dist` 后，需要确保在发布或构建前执行各包的 `build`。

## 建议的后续迭代
- 环境校验完善：在 Web/BFF 启动处加入必需变量的格式校验与异常日志。
- 测试扩展：为 `api/rag/*` 与 `api/deepseek` 增加集成测试与错误路径覆盖；考虑加入 E2E。
- 部署标准化：添加 Web/BFF 的生产 `Dockerfile` 与 Compose，并在 CI 中集成镜像构建。
- 可观测性：抽象日志接口以支持外部后端，并统一记录关键路由耗时与错误。
