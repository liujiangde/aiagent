# 模块启动说明

## 前置准备
- Node：`>= 20`（根 `package.json:5-7`）
- 包管理：启用 `pnpm`
  - `corepack enable && corepack prepare pnpm@9.0.0 --activate`
- 依赖安装：在仓库根执行
  - `pnpm install`

## 共享包（packages/*）
- 目的：产出到 `dist` 以供应用使用
- 构建命令：
  - `pnpm --filter @aiagent/retrieval build`（`packages/retrieval/package.json:7-10`）
  - `pnpm --filter @aiagent/tools build`（`packages/tools/package.json:7-10`）
  - `pnpm --filter @aiagent/ui build`（`packages/ui/package.json:7-10`）
- 入口为 `dist`：
  - `packages/ui/package.json:5-7`、`packages/tools/package.json:5-7`

## Web 应用（apps/web）
- 开发启动：
  - `pnpm --filter web dev`（`apps/web/package.json:5-10`，运行 `next dev -p 3000`）
  - 或根脚本：`pnpm run dev`（`package.json:12-19` 调用 `turbo run dev --filter=web --include-dependencies`）
- 访问地址：`http://localhost:3000/`
- 环境变量：
  - 在 `apps/web/.env.local` 设置：
    - `DEEPSEEK_API_KEY=你的密钥`（读取位置：`apps/web/app/lib/env.ts:7-12`）
  - 示例文件为占位：`apps/web/.env.example:1-2`
- 运行时提示：
  - 页面 Header 显示缺失键提示（`apps/web/components/AppLayout.tsx:19-33, 44-51`）
- 环境校验接口：
  - `GET /api/env-check` 返回 `{ ok, missing, keys }`（`apps/web/app/api/env-check/route.ts:3-12`）

## BFF 服务（apps/bff）
- 开发启动：
  - `pnpm --filter bff-service dev`（`apps/bff/package.json:6-11`，运行 `tsx watch src/index.ts`）
- 端口与环境：
  - 默认为 `4000`，可通过 `PORT` 设置（解析位置：`apps/bff/src/env.ts:1-6`，入口使用：`apps/bff/src/index.ts:23-27`）
- 健康检查：
  - `GET /health`（`apps/bff/src/index.ts:19-21`）

## CLI（apps/cli）
- 构建：
  - `pnpm --filter cli build`（`apps/cli/package.json:5-9`）
- 启动：
  - `pnpm --filter cli start`（运行 `node dist/index.js`）
- 依赖于工具包：
  - `@aiagent/tools`（`apps/cli/package.json:10-16`），需先构建共享包 `dist`

## 质量与格式化
- Lint：`pnpm run lint`（`package.json:12-19`）
- Test：`pnpm run test`（`package.json:12-19`，Vitest 管线）
- Format：`pnpm run format` / `pnpm run format:check`（`.prettierrc`）

## Docker 开发
- Dockerfile（Web 开发）：`Dockerfile.dev`
  - 构建：`docker build -f Dockerfile.dev -t aiagent-web-dev .`
  - 运行：`docker run -p 3000:3000 --env-file apps/web/.env.local aiagent-web-dev`
- Compose：`docker-compose.dev.yml`
  - 启动：`docker compose -f docker-compose.dev.yml up --build`
  - 环境变量透传：`DEEPSEEK_API_KEY`、`OPENAI_API_KEY`（`docker-compose.dev.yml:8-12`）

## 常见问题
- `npm ci` 报错缺少锁文件：改用 `pnpm install`
- 无法解析 `@aiagent/tsconfig`：确保依赖声明为 `workspace:*`（如 `apps/web/package.json:21-28`、`apps/bff/package.json:17-24`）
- TypeScript Node/React 类型缺失：在包侧添加 `@types/node` / `@types/react` 并调整 TS `types/lib`（`packages/retrieval/tsconfig.json:2-14`、`packages/tools/tsconfig.json:3-10`、`packages/ui/package.json:12-21`）
