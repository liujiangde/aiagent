# 环境校验建议

## 目标
- 在开发与运行时快速识别缺失或不合法的环境变量，避免构建与路由层的隐蔽失败。

## 已实现
- Web 环境模块：`apps/web/app/lib/env.ts` 提供：
  - `getEnv(key)`：读取并修剪
  - `getDeepseekKey()`：读取密钥
  - `validateRequired(keys)`：返回 `{ ok, missing }`
  - `requireDeepseekKey()`：缺失时抛错
- 路由接入：
  - `deepseek`、`rag/answer`、`rag/kb_answer`、`rag/stream` 使用统一读取
  - `env-check` 返回综合校验结果（缺失清单与键状态）
- 测试：
  - `apps/web/__tests__/env.test.ts` 与 `env-validate.test.ts` 覆盖缺失与修剪行为

## 推荐做法
- 启动校验
  - 在 Web 的入口 Provider 加载时调用一次 `validateRequired([...])`，将结果写入日志或状态展示页面。
  - 在 BFF 启动前校验必需变量（当前仅端口），后续如接入第三方服务，统一增加校验模块。
- 路由容错
  - 路由调用第三方接口前统一调用 `requireDeepseekKey()`，缺失时用 400 返回标准错误结构。
- 文档与示例
  - 示例环境文件仅保留占位（不包含真实密钥），并在部署说明明确所需变量与来源。
- 进一步加强
  - 引入轻量校验库（如 `zod/envalid`）并集中定义 schema（可选）。
  - 将校验结果纳入健康检查或 `/api/metrics/summary` 聚合。

## 接入点参考
- 模块：`apps/web/app/lib/env.ts:1-20`
- 路由：`apps/web/app/api/env-check/route.ts:3-12`
- 测试：`apps/web/__tests__/env-validate.test.ts:1-21`
